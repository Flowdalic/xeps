<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE xep SYSTEM 'xep.dtd' [
  <!ENTITY % ents SYSTEM 'xep.ent'>
%ents;
]>
<?xml-stylesheet type='text/xsl' href='xep.xsl'?>
<xep>
<header>
  <title>Atomically Compare-And-Publish PubSub Items</title>
  <abstract>This specification provides a mechanism to atomically Compare-And-Publish items to a PubSub node.</abstract>
  &LEGALNOTICE;
  <number>xxxx</number>
  <status>ProtoXEP</status>
  <type>Standards Track</type>
  <sig>Standards</sig>
  <approver>Council</approver>
  <dependencies>
    <spec>XEP-0030</spec>
    <spec>XEP-0060</spec>
  </dependencies>
  <supersedes/>
  <supersededby/>
  <shortname>cap</shortname>
  &flow;
  <revision>
    <version>0.0.2</version>
    <date>2017-08-25</date>
    <initials>fs</initials>
    <remark><p>Use PubSub publish-options preconditions.</p></remark>
  </revision>
  <revision>
    <version>0.0.1</version>
    <date>2017-04-20</date>
    <initials>fs</initials>
    <remark><p>First draft.</p></remark>
  </revision>
</header>

<section1 topic='Introduction' anchor='intro'>

  <p>This specification provides a mechanism to atomically publish
  items to a PubSub node depending on the item ID of the node's latest
  item. This allows to prevent race conditions and avoids data
  loss in certain situations.</p>

</section1>

<section1 topic='Discoverying Support' anchor='disco'>

  <p>If an entity supports the Compared-And-Publish feature it MUST
  advertise the fact by returning a &lt;feature/&gt; with the 'var'
  attribute set to 'urn:xmpp:pubsub:cap:0' in response to a &xep0030;
  query for information.</p>

</section1>

<section1 topic='Compare-And-Publish PubSub Items' anchor='cap'>

  <p>In order to atomically compare-and-publish an item, a client
  sends a <cite>XEP-0060</cite> &lt;publish/&gt; IQ with a
  'pubsub#prev_item_id' precondition publishing option. The option
  field's value MUST contain an item ID.</p>

  <p>The PubSub service MUST only publish the item if the node's
  latest item ID is equal to the ID found in the 'pubsub#prev_item_id'
  field.</p>

      <example caption='Atomically publishing with Compare-And-Publish'><![CDATA[
<iq type='set'
    from='hamlet@denmark.lit/blogbot'
    to='pubsub.shakespeare.lit'
    id='pub1'>
  <pubsub xmlns='http://jabber.org/protocol/pubsub'>
    <publish node='princely_musings'>
      <item id='2'>
        <entry xmlns='https://example.org'>
          <title>Soliloquy</title>
          <summary>
To be, or not to be: that is the question:
Whether 'tis nobler in the mind to suffer
The slings and arrows of outrageous fortune,
Or to take arms against a sea of troubles,
And by opposing end them?
          </summary>
        </entry>
      </item>
    </publish>
    <publish-options>
      <x xmlns='jabber:x:data' type='submit'>
        <field var='FORM_TYPE' type='hidden'>
          <value>http://jabber.org/protocol/pubsub#publish-options</value>
        </field>
        <field var='pubsub#prev_item_id'>
          <value>1</value>
        </field>
      </x>
    </publish-options>
  </pubsub>
</iq>
]]></example>

  <section2 topic='Could not publish because newest item ID did not match'>

    <p>In case the Compare-And-Publish operation failed because the
    latest node id is not the same as given in the 'previd' attribute
    in the request, the server returns an &lt;conflict/&gt; error of
    type 'modify' which a pubsub-specific condition of
    &gt;precondition-not-met/&lt; and a
    &lt;compare-and-publish-failed/&gt; element qualifed by the
    'urn:xmpp:pubsub:cap:0' namespace. The element MUST have a 'id'
    attribute with the ID of the lastest item.</p>

    <example caption='Service returns IQ response notifying of failed Compare-And-Publish operation'><![CDATA[
<iq type='error'
    from='pubsub.shakespeare.lit'
    to='hamlet@denmark.lit/elsinore'
    id='retract1'>
  <error type='modify'>
    <conflict xmlns='urn:ietf:params:xml:ns:xmpp-stanzas'/>
    <precondition-not-met xmlns='http://jabber.org/protocol/pubsub#errors'/>
    <compare-and-publish-failed xmlns='urn:xmpp:pubsub:cap:0' id='2'/>
  </error>
</iq>
]]></example>

  </section2>

</section1>

<section1 topic='Security Considerations' anchor='security'>

  <p>This extension protocol does not add any further security
  considerations to the ones mentioned in <cite>XEP-0060 ยง
  14.</cite>.</p>

</section1>

<section1 topic='IANA Considerations' anchor='iana'>

  <p>This document requires no interaction with the Internet Assigned
  Numbers Authority (IANA).</p>

</section1>

<section1 topic='XMPP Registrar Considerations' anchor='registrar'>

  <p>This specification defines the following XML namespaces:</p>
  <ul>
    <li>urn:xmpp:pubsub:cap:0</li>
  </ul>
    <code caption='Registry Submission'><![CDATA[
<var>
    <name>urn:xmpp:pubsub:cap:0</name>
    <desc>Indicates support for Compare-And-Publish</desc>
    <doc>XEP-XXXX</doc>
</var>]]></code>

    <p>This specification defines the following &gt;publish-options/&lt; fields:</p>
    <ul>
      <li>pubsub#prev_item_id</li>
    </ul>
    <code caption='Registry Submission'><![CDATA[
<field var='pubsub#prev-item-id'
         type='text-single'
         label='Precondition: The latest item ID value of the node'/>]]></code>

</section1>

<section1 topic='XML Schema' anchor='schema'>

  <p>TODO: Add after the XEP leaves the 'experimental' state.</p>

</section1>

<section1 topic='Acknowledgements' anchor='acknowledgements'>

  <p>Thanks to Kim Alvefur and Dave Cridland for their feedback.</p>

</section1>

</xep>
